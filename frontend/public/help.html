<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Help Guide - TradeManthan Scan Page</title>
    <link rel="icon" href="favicon.ico" type="image/x-icon">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            line-height: 1.6;
            color: #333;
            background: #f5f5f5;
        }

        /* Header */
        .header {
            background: linear-gradient(135deg, #1e40af 20%, #000000 80%);
            color: white;
            padding: 30px 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            position: sticky;
            top: 0;
            z-index: 1000;
        }

        .header-content {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .header h1 {
            font-size: 28px;
            font-weight: 600;
        }

        .header-subtitle {
            font-size: 14px;
            opacity: 0.9;
            margin-top: 5px;
        }

        /* Dropdown Menu Styles */
        .menu-dropdown {
            position: relative;
            display: inline-block;
        }

        .menu-btn {
            background: rgba(255,255,255,0.2);
            color: white;
            border: 1px solid rgba(255,255,255,0.3);
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
            white-space: nowrap;
        }

        .menu-btn:hover {
            background: rgba(255,255,255,0.3);
            transform: translateY(-2px);
        }

        .menu-dropdown-content {
            display: none;
            position: absolute;
            right: 0;
            background: white;
            min-width: 200px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
            border-radius: 8px;
            z-index: 1000;
            margin-top: 5px;
            overflow: hidden;
        }

        .menu-dropdown-content a {
            color: #2d3748;
            padding: 12px 20px;
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: all 0.2s;
            border-bottom: 1px solid #e2e8f0;
        }

        .menu-dropdown-content a:last-child {
            border-bottom: none;
        }

        .menu-dropdown-content a:hover {
            background: #f7fafc;
            padding-left: 24px;
        }

        .menu-dropdown-content a i {
            width: 20px;
            text-align: center;
        }

        .menu-dropdown-content a.scan-link i {
            color: #0891b2;
        }

        .menu-dropdown-content a.report-link i {
            color: #28a745;
        }

        .menu-dropdown-content a.logs-link i {
            color: #6610f2;
        }

        .menu-dropdown-content a.help-link i {
            color: #1e40af;
        }

        .menu-dropdown.show .menu-dropdown-content {
            display: block;
            animation: slideDown 0.3s ease;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Mobile Bottom Bar */
        .mobile-bottom-bar {
            display: none;
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(30, 64, 175, 0.95);
            backdrop-filter: blur(10px);
            padding: 15px 20px;
            box-shadow: 0 -4px 12px rgba(0, 0, 0, 0.3);
            z-index: 999;
            justify-content: center;
            align-items: center;
        }

        .mobile-menu-btn {
            background: white;
            color: #1e40af;
            border: none;
            border-radius: 50%;
            width: 56px;
            height: 56px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            margin: 0 auto;
            font-size: 24px;
            font-weight: bold;
            transition: all 0.3s ease;
        }

        .mobile-menu-btn:hover {
            transform: scale(1.1);
        }

        .mobile-menu-btn:active {
            transform: scale(0.95);
        }

        /* Mobile Drawer */
        .mobile-drawer {
            display: none;
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            border-radius: 20px 20px 0 0;
            box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.3);
            z-index: 1001;
            transform: translateY(100%);
            transition: transform 0.3s ease;
        }

        .mobile-drawer.show {
            display: block;
            transform: translateY(0);
            animation: slideUp 0.3s ease;
        }

        @keyframes slideUp {
            from { transform: translateY(100%); }
            to { transform: translateY(0); }
        }

        .drawer-handle {
            text-align: center;
            padding: 15px 0 10px;
        }

        .drawer-handle-bar {
            width: 40px;
            height: 4px;
            background: #cbd5e0;
            border-radius: 2px;
            display: inline-block;
        }

        .drawer-header {
            padding: 10px 20px 15px;
            border-bottom: 2px solid #e2e8f0;
        }

        .drawer-header h3 {
            color: #2d3748;
            font-size: 18px;
            margin: 0;
        }

        .drawer-menu {
            padding: 10px 0;
            max-height: 60vh;
            overflow-y: auto;
        }

        .drawer-menu a {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 16px 20px;
            color: #2d3748;
            text-decoration: none;
            transition: all 0.2s;
            border-bottom: 1px solid #f7fafc;
        }

        .drawer-menu a:last-child {
            border-bottom: none;
        }

        .drawer-menu a:active {
            background: #edf2f7;
        }

        .drawer-menu a i {
            width: 24px;
            text-align: center;
            font-size: 20px;
        }

        .drawer-menu a.scan-link i { color: #0891b2; }
        .drawer-menu a.report-link i { color: #28a745; }
        .drawer-menu a.logs-link i { color: #6610f2; }
        .drawer-menu a.help-link i { color: #1e40af; }

        .drawer-menu a span {
            font-size: 16px;
            font-weight: 500;
        }

        .drawer-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
        }

        .drawer-overlay.show {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        /* Show mobile bottom bar on mobile screens */
        @media (max-width: 768px) {
            .mobile-bottom-bar {
                display: flex;
            }

            .menu-dropdown-desktop {
                display: none;
            }

            body {
                padding-bottom: 90px;
            }
        }

        /* Container */
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            display: grid;
            grid-template-columns: 280px 1fr;
            gap: 30px;
        }

        /* Sidebar TOC */
        .toc {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            position: sticky;
            top: 120px;
            height: fit-content;
            max-height: calc(100vh - 140px);
            overflow-y: auto;
        }

        .toc h2 {
            font-size: 18px;
            margin-bottom: 15px;
            color: #1e40af;
            border-bottom: 2px solid #1e40af;
            padding-bottom: 10px;
        }

        .toc ul {
            list-style: none;
        }

        .toc li {
            margin-bottom: 8px;
        }

        .toc a {
            color: #666;
            text-decoration: none;
            font-size: 14px;
            transition: all 0.3s;
            display: block;
            padding: 5px 10px;
            border-radius: 6px;
        }

        .toc a:hover {
            background: #f0f4ff;
            color: #1e40af;
            padding-left: 15px;
        }

        .toc .user-section {
            color: #16a34a;
            font-weight: 500;
        }

        .toc .dev-section {
            color: #dc2626;
            font-weight: 500;
        }

        /* Main Content */
        .content {
            background: white;
            padding: 40px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        /* Quick Start Banner */
        .quick-start {
            background: linear-gradient(135deg, #f8fafc, #e2e8f0);
            color: #1e293b;
            padding: 30px;
            border-radius: 12px;
            margin-bottom: 30px;
            border: 2px solid #cbd5e1;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }

        .quick-start h2 {
            font-size: 24px;
            margin-bottom: 15px;
            color: #1e40af;
        }

        .quick-start ul {
            margin-left: 20px;
            margin-top: 10px;
        }

        .quick-start li {
            margin-bottom: 8px;
            color: #475569;
        }
        
        .quick-start strong {
            color: #1e293b;
        }

        /* Section Headers */
        .section-header {
            font-size: 28px;
            color: #1e40af;
            margin: 40px 0 20px 0;
            padding-bottom: 10px;
            border-bottom: 3px solid #1e40af;
        }

        .section-header:first-child {
            margin-top: 0;
        }

        h2 {
            font-size: 24px;
            color: #333;
            margin-top: 30px;
            margin-bottom: 15px;
        }

        h3 {
            font-size: 20px;
            color: #555;
            margin-top: 25px;
            margin-bottom: 12px;
        }

        h4 {
            font-size: 18px;
            color: #666;
            margin-top: 20px;
            margin-bottom: 10px;
        }

        /* Paragraphs and Lists */
        p {
            margin-bottom: 15px;
            color: #555;
        }

        ul, ol {
            margin-left: 25px;
            margin-bottom: 15px;
        }

        li {
            margin-bottom: 8px;
            color: #555;
        }

        /* Code and Pre */
        code {
            background: #f1f5f9;
            padding: 2px 6px;
            border-radius: 4px;
            font-family: 'Monaco', 'Courier New', monospace;
            font-size: 13px;
            color: #dc2626;
        }

        pre {
            background: #1e293b;
            color: #e2e8f0;
            padding: 20px;
            border-radius: 8px;
            overflow-x: auto;
            margin: 15px 0;
            font-size: 14px;
            line-height: 1.5;
        }

        pre code {
            background: none;
            color: inherit;
            padding: 0;
        }

        /* Tables */
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        th {
            background: #1e40af;
            color: white;
            padding: 12px;
            text-align: left;
            font-weight: 600;
        }

        td {
            padding: 12px;
            border-bottom: 1px solid #e5e7eb;
        }

        tr:nth-child(even) {
            background: #f9fafb;
        }

        /* Info Boxes */
        .info-box {
            background: #eff6ff;
            border-left: 4px solid #3b82f6;
            padding: 15px 20px;
            margin: 20px 0;
            border-radius: 6px;
        }

        .warning-box {
            background: #fef3c7;
            border-left: 4px solid #f59e0b;
            padding: 15px 20px;
            margin: 20px 0;
            border-radius: 6px;
        }

        .success-box {
            background: #d1fae5;
            border-left: 4px solid #10b981;
            padding: 15px 20px;
            margin: 20px 0;
            border-radius: 6px;
        }

        .danger-box {
            background: #fee2e2;
            border-left: 4px solid #ef4444;
            padding: 15px 20px;
            margin: 20px 0;
            border-radius: 6px;
        }

        /* User vs Developer Sections */
        .user-content {
            border-left: 5px solid #16a34a;
            padding-left: 20px;
            margin: 20px 0;
        }

        .dev-content {
            border-left: 5px solid #dc2626;
            padding-left: 20px;
            margin: 20px 0;
        }

        /* Badges */
        .badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            margin-right: 8px;
        }

        .badge-user {
            background: #d1fae5;
            color: #065f46;
        }

        .badge-dev {
            background: #fee2e2;
            color: #991b1b;
        }

        /* Responsive - Tablet */
        @media (max-width: 968px) {
            .container {
                grid-template-columns: 1fr;
            }

            .toc {
                position: static;
                max-height: none;
            }

            .content {
                padding: 20px;
            }
        }

        /* Mobile Optimization */
        @media (max-width: 768px) {
            body {
                padding: 0;
            }

            .header {
                padding: 20px 15px;
                position: relative;
            }

            .header-content {
                flex-direction: column;
                gap: 15px;
                text-align: center;
            }

            .header h1 {
                font-size: 22px;
            }

            .header-subtitle {
                font-size: 13px;
            }

            .menu-btn {
                font-size: 14px;
                padding: 8px 16px;
            }

            .container {
                padding: 15px;
                gap: 20px;
            }

            .toc {
                padding: 15px;
                border-radius: 8px;
                margin-bottom: 15px;
            }

            .toc h2 {
                font-size: 16px;
                margin-bottom: 12px;
            }

            .toc ul li a {
                font-size: 13px;
                padding: 8px 12px;
            }

            .content {
                padding: 15px;
            }

            .content h2 {
                font-size: 20px;
                margin-top: 20px;
                margin-bottom: 12px;
            }

            .content h3 {
                font-size: 17px;
                margin-top: 15px;
                margin-bottom: 10px;
            }

            .content h4 {
                font-size: 15px;
                margin-top: 12px;
                margin-bottom: 8px;
            }

            .content p, .content li {
                font-size: 14px;
                line-height: 1.6;
            }

            .content ul, .content ol {
                padding-left: 20px;
            }

            .info-box {
                padding: 12px;
                margin: 15px 0;
                border-radius: 8px;
            }

            .info-box strong {
                font-size: 14px;
            }

            .info-box ul {
                font-size: 13px;
            }

            code {
                font-size: 13px;
                padding: 2px 6px;
            }

            pre code {
                font-size: 12px;
                padding: 12px;
            }

            table {
                font-size: 13px;
                display: block;
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }

            table th, table td {
                padding: 8px 10px;
                white-space: nowrap;
            }

            .scroll-top {
                width: 45px;
                height: 45px;
                bottom: 20px;
                right: 20px;
            }

            /* Improve readability on mobile */
            .section {
                scroll-margin-top: 80px;
            }

            /* Better spacing for mobile */
            .content > * + * {
                margin-top: 12px;
            }

            .content > h2 + * {
                margin-top: 15px;
            }

            .content > h3 + * {
                margin-top: 12px;
            }
        }

        /* Small Mobile Devices */
        @media (max-width: 480px) {
            .header h1 {
                font-size: 18px;
            }

            .header-subtitle {
                font-size: 12px;
            }

            .container {
                padding: 10px;
            }

            .toc {
                padding: 12px;
            }

            .content {
                padding: 12px;
            }

            .content h2 {
                font-size: 18px;
            }

            .content h3 {
                font-size: 16px;
            }

            .content h4 {
                font-size: 14px;
            }

            .content p, .content li {
                font-size: 13px;
            }

            .info-box {
                padding: 10px;
                font-size: 13px;
            }

            table {
                font-size: 12px;
            }

            table th, table td {
                padding: 6px 8px;
            }
        }

        /* Scroll to top button */
        .scroll-top {
            position: fixed;
            bottom: 30px;
            right: 30px;
            background: #1e40af;
            color: white;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            transition: all 0.3s;
            opacity: 0;
            visibility: hidden;
        }

        .scroll-top.visible {
            opacity: 1;
            visibility: visible;
        }

        .scroll-top:hover {
            background: #1e3a8a;
            transform: translateY(-5px);
        }
    </style>
</head>
<body>

    <!-- Header -->
    <div class="header">
        <div class="header-content">
            <div>
                <h1><i class="fas fa-book"></i> TradeManthan - Help Guide</h1>
                <div class="header-subtitle">Complete guide for Scan Page - For Users & Developers</div>
            </div>
            <div class="menu-dropdown menu-dropdown-desktop" id="menu-dropdown">
                <button class="menu-btn" onclick="toggleMenu()" title="Menu">
                    <i class="fas fa-bars"></i> Menu <i class="fas fa-chevron-down" style="font-size: 10px;"></i>
                </button>
                <div class="menu-dropdown-content">
                    <a href="scan.html" class="scan-link">
                        <i class="fas fa-search"></i> Scan Dashboard
                    </a>
                    <a href="reportscan.html" class="report-link">
                        <i class="fas fa-chart-bar"></i> Trading Report
                    </a>
                    <a href="scanlog.html" class="logs-link">
                        <i class="fas fa-file-alt"></i> Scan Logs
                    </a>
                    <a href="help.html" class="help-link">
                        <i class="fas fa-question-circle"></i> Help Guide
                    </a>
                </div>
            </div>
        </div>
    </div>
    <!-- Main Container -->
    <div class="container">
        
        <!-- Table of Contents -->
        <aside class="toc">
            <h2><i class="fas fa-list"></i> Contents</h2>
            <ul>
                <li><a href="#quick-start">üéØ Quick Start</a></li>
                <li class="user-section"><a href="#for-users">üì± FOR END USERS</a></li>
                <ul>
                    <li><a href="#what-happens-automatically">What Happens Automatically</a></li>
                    <li><a href="#understanding-dashboard">Understanding the Dashboard</a></li>
                    <li><a href="#reading-signals">Reading Trading Signals</a></li>
                    <li><a href="#daily-tasks">Daily Automated Tasks</a></li>
                    <li><a href="#user-summary">User-Friendly Summary</a></li>
                </ul>
                <li class="dev-section"><a href="#for-developers">üë®‚Äçüíª FOR DEVELOPERS</a></li>
                <ul>
                    <li><a href="#page-initialization">Page Initialization Flow</a></li>
                    <li><a href="#index-monitoring">Index Price Monitoring</a></li>
                    <li><a href="#webhook-processing">Webhook Processing</a></li>
                    <li><a href="#trading-logic">Trading Logic & Algorithms</a></li>
                    <li><a href="#authentication">Authentication Flows</a></li>
                    <li><a href="#api-endpoints">API Endpoints</a></li>
                    <li><a href="#system-workflow">üìä System Workflow (Complete)</a></li>
                </ul>
            </ul>
        </aside>

        <!-- Main Content -->
        <main class="content">

            <!-- Recent Updates Banner -->
            <div class="success-box" style="margin-bottom: 30px;">
                <h2 style="color: #059669; margin-bottom: 15px;">üéâ Recent Updates & Improvements</h2>
                <p><strong>Latest enhancements to the system (November 2025):</strong></p>
                <ul style="margin-left: 20px; margin-top: 10px;">
                    <li>‚úÖ <strong>Hourly Sell Price Updates:</strong> Option LTP now refreshes every hour for accurate tracking</li>
                    <li>‚úÖ <strong>Stop Loss Rounding:</strong> SL now rounds down to nearest 10 paise for cleaner pricing</li>
                    <li>‚úÖ <strong>Token Persistence:</strong> Upstox token survives server restarts (no daily re-login!)</li>
                    <li>‚úÖ <strong>Bug Fixes:</strong> Fixed instruments data parsing, OHLC API interval, sell_time updates</li>
                    <li>‚úÖ <strong>OHLC API Fix:</strong> Webhook failures resolved (interval changed from "day" to "1d")</li>
                    <li>‚úÖ <strong>Day Summary:</strong> Collapsible daily metrics (Net P&L, Win Rate, Trades)</li>
                    <li>‚úÖ <strong>Complete Workflow Documentation:</strong> Added comprehensive system flow diagram</li>
                </ul>
            </div>

            <!-- Quick Start -->
            <div id="quick-start" class="quick-start">
                <h2>üéØ Quick Start (For End Users)</h2>
                <p><strong>What does this page do?</strong></p>
                <ul>
                    <li>‚úÖ Monitors NIFTY & BANKNIFTY market direction (every hour)</li>
                    <li>‚úÖ Receives real-time stock alerts from Chartink.com</li>
                    <li>‚úÖ <strong>Shows ALL alerts regardless of index trends (NEW!)</strong></li>
                    <li>‚úÖ Automatically enters trades ONLY when trends align</li>
                    <li>‚úÖ Shows you exactly what to buy, Stop Loss, profit targets</li>
                    <li>‚úÖ Auto-closes all trades by 3:25 PM daily (intraday only)</li>
                </ul>
                <p><strong>How to use:</strong></p>
                <ol>
                    <li>Open the page - it starts working automatically</li>
                    <li>Look at index trends (green ‚Üë = bullish, red ‚Üì = bearish)</li>
                    <li><strong>See ALL alerts in both bullish and bearish sections</strong></li>
                    <li>Alerts with Buy Price = Trade ENTERED (when trends aligned)</li>
                    <li>Alerts with "No Entry" (red) = NOT entered (opposite trends)</li>
                    <li>Monitor: ‚úñ Exit signal, üõë SL HIT, üéØ TARGET, ‚è∞ TIME badges</li>
                    <li>Download CSV for your records</li>
                </ol>
            </div>

            <!-- FOR END USERS SECTION -->
            <div id="for-users">
                <h1 class="section-header">üì± FOR END USERS</h1>

                <!-- What Happens Automatically -->
                <div id="what-happens-automatically" class="user-content">
                    <h2>What Happens Automatically</h2>
                    <p>When you open <code>https://trademanthan.in/scan.html</code>, the system automatically:</p>

                    <h3>‚è∞ Every Hour (at 9:15 AM, 10:15 AM, 11:15 AM, etc.)</h3>
                    
                    <h4>1. Checks Market Direction</h4>
                    <ul>
                        <li>Fetches NIFTY 50 current price</li>
                        <li>Fetches BANKNIFTY current price</li>
                        <li>Determines if market is bullish (green ‚Üë) or bearish (red ‚Üì)</li>
                        <li>Shows you the trend in the title bar</li>
                    </ul>

                    <div class="info-box">
                        <strong>How it determines trend:</strong><br>
                        ‚Ä¢ If index price is <strong>ABOVE</strong> today's opening price = Green candle = Bullish ‚Üë<br>
                        ‚Ä¢ If index price is <strong>BELOW</strong> today's opening price = Red candle = Bearish ‚Üì
                    </div>

                    <h4>2. Updates Trading Alerts</h4>
                    <ul>
                        <li>Refreshes all stock alerts</li>
                        <li>Updates prices and profit calculations</li>
                        <li>Shows latest Hold/Exit signals</li>
                    </ul>

                    <h3>üîî When Chartink Sends Alert (Real-time)</h3>
                    <p><strong>The system instantly:</strong></p>
                    <ol>
                        <li>Receives stock name and price from Chartink scanner</li>
                        <li>Fetches current market price from Upstox</li>
                        <li>Finds the best option contract (highest liquidity)</li>
                        <li><strong>Checks index trends (NIFTY & BANKNIFTY)</strong></li>
                        <li><strong>Decides: Enter trade OR mark "No Entry"</strong></li>
                        <li>Displays the alert with entry status</li>
                    </ol>

                    <div class="success-box">
                        <strong>You ALWAYS see:</strong><br>
                        ‚Ä¢ üìà BULLISH section - ALL bullish alerts (entered or not)<br>
                        ‚Ä¢ üìâ BEARISH section - ALL bearish alerts (entered or not)<br>
                        ‚Ä¢ <strong>Both sections shown regardless of index trends!</strong>
                    </div>

                    <h3>üéØ Trade Entry Decision</h3>
                    <div class="warning-box">
                        <strong>Index trends control TRADE ENTRY, not alert visibility!</strong>
                    </div>

                    <p><strong>If Both Indices Same Direction:</strong></p>
                    <ul>
                        <li>‚úÖ Trade is ENTERED</li>
                        <li>‚úÖ Buy Price set to option price</li>
                        <li>‚úÖ Quantity set to lot size (e.g., 250)</li>
                        <li>‚úÖ Stop Loss calculated</li>
                        <li>‚úÖ Trade tracking begins</li>
                    </ul>

                    <p><strong>If Indices Opposite Directions:</strong></p>
                    <ul>
                        <li>‚ö†Ô∏è Trade is NOT entered</li>
                        <li>‚ö†Ô∏è Buy Price shows <strong>"No Entry"</strong> (red)</li>
                        <li>‚ö†Ô∏è Quantity = 0</li>
                        <li>‚ö†Ô∏è Alert still displayed for information</li>
                        <li>‚ö†Ô∏è Will NEVER be entered later (permanent "No Entry")</li>
                    </ul>
                </div>

                <!-- Understanding the Dashboard -->
                <div id="understanding-dashboard" class="user-content">
                    <h2>Understanding the Dashboard</h2>

                    <h3>üéØ Title Bar (Always Visible)</h3>
                    <pre>
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  Logo  |  TradeManthan - Intraday Options Algo  ‚îÇ
‚îÇ        |  NIFTY 50: 24,500 ‚Üë  BANKNIFTY: 52,300 ‚Üë‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò</pre>

                    <div class="info-box">
                        <strong>What each symbol means:</strong><br>
                        ‚Ä¢ ‚Üë Green Arrow = Bullish (price above today's open)<br>
                        ‚Ä¢ ‚Üì Red Arrow = Bearish (price below today's open)<br>
                        ‚Ä¢ ‚Üí Gray Arrow = Neutral (no clear trend)
                    </div>

                    <h3>‚ö†Ô∏è Warning Messages</h3>
                    
                    <div class="warning-box">
                        <strong>"Access Token Expired" - IMPROVED!</strong><br>
                        ‚Ä¢ <strong>What it means:</strong> Connection to Upstox expired<br>
                        ‚Ä¢ <strong>What to do:</strong> Click "Update Token" ‚Üí "Login with Upstox"<br>
                        ‚Ä¢ <strong>Why:</strong> You need active Upstox connection for live data<br>
                        ‚Ä¢ <strong>üÜï NEW:</strong> Token now persists across server restarts<br>
                        ‚Ä¢ <strong>üÜï NEW:</strong> Automatic token health checks every hour<br>
                        ‚Ä¢ <strong>üÜï NEW:</strong> Instant token updates without server restart
                    </div>
                    
                    <div class="info-box">
                        <strong>üÜï Token Persistence (NEW!):</strong><br>
                        ‚Ä¢ Upstox token is saved to file: <code>/home/ubuntu/trademanthan/data/upstox_token.json</code><br>
                        ‚Ä¢ Token survives server restarts (no more daily re-login!)<br>
                        ‚Ä¢ Automatic reload on startup<br>
                        ‚Ä¢ Health monitor checks token validity every 15 minutes<br>
                        ‚Ä¢ Frontend displays banner if token needs refresh
                    </div>

                    <div class="info-box">
                        <strong>"No Entry" Status (NEW!)</strong><br>
                        ‚Ä¢ <strong>What it means:</strong> Alert received when NIFTY and BANKNIFTY had opposite trends<br>
                        ‚Ä¢ <strong>What you see:</strong> Alert displayed with "No Entry" in red in Buy Price column<br>
                        ‚Ä¢ <strong>Trade status:</strong> NOT entered, Qty=0, no SL/Sell/PnL tracking<br>
                        ‚Ä¢ <strong>Will it enter later?:</strong> NO - permanently "No Entry"<br>
                        ‚Ä¢ <strong>Why shown?:</strong> For complete market awareness - you see all signals
                    </div>

                    <h3>üìä Trading Alert Tables</h3>
                    <p>Each alert shows you:</p>
                    <table>
                        <thead>
                            <tr>
                                <th>Column</th>
                                <th>What It Means</th>
                                <th>Example</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td><strong>Stock Name</strong></td>
                                <td>Company symbol</td>
                                <td>RELIANCE</td>
                            </tr>
                            <tr>
                                <td><strong>Stock LTP</strong></td>
                                <td>Current stock price</td>
                                <td>‚Çπ2,450</td>
                            </tr>
                            <tr>
                                <td><strong>Stock VWAP</strong></td>
                                <td>Average price (volume-weighted)</td>
                                <td>‚Çπ2,448</td>
                            </tr>
                            <tr>
                                <td><strong>Option Contract</strong></td>
                                <td>Exact option to trade</td>
                                <td>RELIANCE 25NOV 2500 CE</td>
                            </tr>
                            <tr>
                                <td><strong>Qty</strong></td>
                                <td>How many contracts</td>
                                <td>250 (lot size)</td>
                            </tr>
                            <tr>
                                <td><strong>Buy Price</strong></td>
                                <td>Entry price per contract</td>
                                <td>‚Çπ25.50</td>
                            </tr>
                            <tr>
                                <td><strong>Stop Loss</strong></td>
                                <td>Auto-calculated SL (‚Çπ3,100 max loss)</td>
                                <td>‚Çπ13.10 (red color)</td>
                            </tr>
                            <tr>
                                <td><strong>Sell Price</strong></td>
                                <td>Current/exit price</td>
                                <td>‚Çπ38.25</td>
                            </tr>
                            <tr>
                                <td><strong>Status</strong></td>
                                <td>Trade status indicator</td>
                                <td>üõë SL HIT / üéØ TARGET / ‚úñ EXIT</td>
                            </tr>
                            <tr>
                                <td><strong>PnL</strong></td>
                                <td>Profit or Loss</td>
                                <td>‚Çπ3,187 or -‚Çπ3,100</td>
                            </tr>
                        </tbody>
                    </table>

                    <h3>üõ°Ô∏è Stop Loss & Risk Management</h3>
                    <div class="warning-box">
                        <strong>Automatic Stop Loss (UPDATED!):</strong><br>
                        ‚Ä¢ Calculated when trade is created<br>
                        ‚Ä¢ Formula: <code>SL = floor((buy_price - 3100/qty) / 0.10) * 0.10</code><br>
                        ‚Ä¢ <strong>Rounded DOWN to nearest 10 paise</strong><br>
                        ‚Ä¢ <strong>Maximum loss per trade: ~‚Çπ3,100</strong><br>
                        ‚Ä¢ Example: Buy ‚Çπ25.50, Qty 250 ‚Üí Calculated: ‚Çπ13.10 ‚Üí Rounded: ‚Çπ13.10<br>
                        ‚Ä¢ Example: Buy ‚Çπ49.88, Qty 150 ‚Üí Calculated: ‚Çπ29.21 ‚Üí Rounded: ‚Çπ29.20<br>
                        ‚Ä¢ Shown in <strong style="color: #dc2626;">red color</strong> in table
                    </div>
                    
                    <h3>üí∞ Sell Price Updates (NEW!)</h3>
                    <div class="info-box">
                        <strong>How Sell Price Works:</strong><br>
                        ‚Ä¢ <strong>At Entry:</strong> Sell Price is BLANK (not set)<br>
                        ‚Ä¢ <strong>First Hourly Update (11:15 AM):</strong> Populated with current option LTP<br>
                        ‚Ä¢ <strong>Every Hour After:</strong> Updated with fresh option LTP from Upstox<br>
                        ‚Ä¢ <strong>Used For:</strong> Stop Loss checks, Profit Target checks, P&L calculation<br>
                        ‚Ä¢ <strong>On Exit:</strong> LOCKED permanently (cannot change)<br>
                        ‚Ä¢ This ensures accurate real-time tracking and exit decisions
                    </div>

                    <h3>üìä Status Indicators</h3>
                    
                    <div class="danger-box">
                        <strong>No Entry (Red Badge - NEW!):</strong><br>
                        ‚Ä¢ Trade was NOT entered due to opposite index trends<br>
                        ‚Ä¢ Buy Price column shows "No Entry" in red<br>
                        ‚Ä¢ Qty = 0, SL/Sell/PnL show "-"<br>
                        ‚Ä¢ Alert visible for market awareness<br>
                        ‚Ä¢ <strong>Will NEVER be entered</strong> (permanent status)
                    </div>

                    <div class="danger-box">
                        <strong>üõë SL HIT (Red Badge):</strong><br>
                        ‚Ä¢ Stop loss has been triggered<br>
                        ‚Ä¢ Trade exited automatically<br>
                        ‚Ä¢ Loss capped at ~‚Çπ3,100<br>
                        ‚Ä¢ <strong>sell_price is LOCKED</strong> (cannot be changed)
                    </div>

                    <div class="success-box">
                        <strong>üéØ TARGET (Green Badge):</strong><br>
                        ‚Ä¢ Profit target reached (50% gain)<br>
                        ‚Ä¢ Trade exited automatically<br>
                        ‚Ä¢ Profit locked in<br>
                        ‚Ä¢ <strong>sell_price is LOCKED</strong> (cannot be changed)
                    </div>

                    <div class="warning-box">
                        <strong>‚è∞ TIME (Orange Badge - NEW!):</strong><br>
                        ‚Ä¢ Time-based exit at 3:25 PM IST<br>
                        ‚Ä¢ ALL open trades auto-closed daily<br>
                        ‚Ä¢ No overnight positions<br>
                        ‚Ä¢ Professional intraday discipline<br>
                        ‚Ä¢ <strong>sell_price is LOCKED</strong> (cannot be changed)
                    </div>

                    <div class="danger-box">
                        <strong>‚úñ EXIT (Big Red Cross - Pulsing):</strong><br>
                        ‚Ä¢ Stock price is BELOW average (VWAP)<br>
                        ‚Ä¢ Market losing momentum<br>
                        ‚Ä¢ <strong>Action:</strong> Consider exiting position<br>
                        ‚Ä¢ Trade still OPEN (not auto-exited)
                    </div>

                    <div class="info-box">
                        <strong>(Empty / Hidden):</strong><br>
                        ‚Ä¢ Stock price is ABOVE average (VWAP)<br>
                        ‚Ä¢ Market has positive momentum<br>
                        ‚Ä¢ <strong>Action:</strong> Continue holding the position<br>
                        ‚Ä¢ No indicator shown for clean UI
                    </div>

                    <h3>‚ö†Ô∏è Important: Trade Closure Protection</h3>
                    <div class="warning-box">
                        <strong>Once a trade is closed (SL HIT or TARGET):</strong><br>
                        ‚Ä¢ <code>sell_price</code> is permanently locked<br>
                        ‚Ä¢ <code>sell_time</code> is permanently locked<br>
                        ‚Ä¢ <code>exit_reason</code> records why trade closed<br>
                        ‚Ä¢ <strong>NO process can overwrite these values</strong><br>
                        ‚Ä¢ Trade history is protected and immutable
                    </div>
                </div>

                <!-- Reading Trading Signals -->
                <div id="reading-signals" class="user-content">
                    <h2>Reading Trading Signals</h2>

                    <h3>Example 1: Bullish Market Setup</h3>
                    <pre>
Title Bar shows:
NIFTY 50: 24,500 ‚Üë (Bullish)
BANKNIFTY: 52,300 ‚Üë (Bullish)</pre>

                    <p><strong>What you see:</strong></p>
                    <ul>
                        <li>‚úÖ Both indices bullish = Trading allowed</li>
                        <li>üìà BULLISH ALERTS section visible</li>
                        <li>Recommendations for CALL (CE) options</li>
                    </ul>

                    <div class="success-box">
                        <strong>Sample Alert:</strong><br>
                        <code>RELIANCE | Stock LTP: ‚Çπ2,450 | VWAP: ‚Çπ2,448 | üü¢ Hold</code><br>
                        <code>Option: RELIANCE 25NOV 2500 CE</code><br>
                        <code>Qty: 250 | Buy: ‚Çπ25.50 | Sell: ‚Çπ38.25 | Profit: ‚Çπ3,187</code>
                    </div>

                    <p><strong>How to read this:</strong></p>
                    <ul>
                        <li>RELIANCE stock triggered at ‚Çπ2,450</li>
                        <li>System suggests buying RELIANCE 25 November 2500 CALL option</li>
                        <li>Buy at ‚Çπ25.50 per contract</li>
                        <li>Quantity: 250 contracts (official lot size)</li>
                        <li>Sell target: ‚Çπ38.25 (50% profit)</li>
                        <li>If target hits: You make ‚Çπ3,187 profit</li>
                        <li>Signal: HOLD (price above average, keep position)</li>
                    </ul>

                    <h3>Example 2: Opposite Trends - No Trading</h3>
                    <pre>
Title Bar shows:
NIFTY 50: 24,500 ‚Üë (Bullish)
BANKNIFTY: 52,300 ‚Üì (Bearish)</pre>

                    <div class="warning-box">
                        <strong>What you see:</strong><br>
                        ‚Ä¢ ‚ö†Ô∏è Warning: "No Trade Applicable"<br>
                        ‚Ä¢ Both sections visible (for information only)<br>
                        ‚Ä¢ Recommendation: Wait for alignment<br><br>
                        <strong>Why:</strong> When indices move in opposite directions, market signals are unclear and trading is risky.
                    </div>
                </div>

                <!-- Daily Automated Tasks -->
                <div id="daily-tasks" class="user-content">
                    <h2>Daily Automated Tasks</h2>
                    <p>The system runs several automated tasks in the background to keep data fresh:</p>

                    <h3>üåÖ Every Morning at 9:00 AM IST</h3>
                    <h4>1. Master Stock Data Download</h4>

                    <div class="info-box">
                        <strong>What happens:</strong><br>
                        ‚Ä¢ Downloads latest instrument data from Dhan API<br>
                        ‚Ä¢ Updates all NSE stock and option details<br>
                        ‚Ä¢ Refreshes lot sizes, strike prices, expiry dates<br>
                        ‚Ä¢ Updates ~50,000+ instrument records
                    </div>

                    <p><strong>Why it matters:</strong></p>
                    <ul>
                        <li>Ensures you have latest option contracts</li>
                        <li>Correct lot sizes for quantity calculations</li>
                        <li>Updated expiry dates for current month</li>
                    </ul>

                    <p><strong>Data includes:</strong></p>
                    <ul>
                        <li>Stock symbols and ISINs</li>
                        <li>Option strike prices</li>
                        <li>Lot sizes (NIFTY: 50, BANKNIFTY: 15, etc.)</li>
                        <li>Expiry dates (last Tuesday of month)</li>
                        <li>Instrument keys for Upstox API</li>
                    </ul>

                    <h3>üìä Daily Data Refresh</h3>
                    <p><strong>What gets updated:</strong></p>
                    <ul>
                        <li><strong>Option contracts</strong> for current month's expiry</li>
                        <li><strong>Lot sizes</strong> (official exchange lot sizes)</li>
                        <li><strong>Strike intervals</strong> (‚Çπ5, ‚Çπ10, ‚Çπ50, ‚Çπ100 based on stock price)</li>
                        <li><strong>Instrument mappings</strong> (for Upstox API calls)</li>
                    </ul>

                    <div class="success-box">
                        <strong>Automatic expiry month switching:</strong><br>
                        ‚Ä¢ If today is <strong>1st to 18th</strong> ‚Üí Uses <strong>current month</strong> options<br>
                        ‚Ä¢ If today is <strong>19th to 31st</strong> ‚Üí Uses <strong>next month</strong> options<br>
                        ‚Ä¢ Switches automatically after 18th of each month
                    </div>

                    <p><strong>Example:</strong></p>
                    <ul>
                        <li>Nov 1-18: Shows November expiry options</li>
                        <li>Nov 19-30: Shows December expiry options</li>
                        <li>Auto-switches on Nov 19th at 9:00 AM</li>
                    </ul>

                    <h3>üîÑ Continuous Updates (Every Hour at :15) - UPDATED!</h3>
                    <p><strong>Starting 9:30 AM IST, then every hour at :15:</strong></p>
                    <p><strong>What refreshes (for ENTERED trades only):</strong></p>
                    <ol>
                        <li>NIFTY & BANKNIFTY prices and trends</li>
                        <li>Stock LTP (current stock price)</li>
                        <li>Stock VWAP (volume-weighted average)</li>
                        <li><strong>üÜï Sell Price (Option LTP) - Hourly refresh from Upstox</strong></li>
                        <li>PnL calculation: (sell_price - buy_price) √ó qty</li>
                        <li>Hold/Exit signals (based on stock_ltp vs VWAP)</li>
                        <li><strong>Exit condition checks (SL, Target, Time)</strong></li>
                    </ol>

                    <div class="success-box">
                        <strong>üÜï NEW: Sell Price Hourly Updates!</strong><br>
                        ‚Ä¢ Fetches current option LTP from Upstox instruments data<br>
                        ‚Ä¢ Updates <code>sell_price</code> field for all open trades<br>
                        ‚Ä¢ Used for real-time SL/Target monitoring<br>
                        ‚Ä¢ Ensures accurate exit decisions based on latest prices<br>
                        ‚Ä¢ Fixed bug: Instruments data is now correctly read as a list
                    </div>

                    <div class="danger-box">
                        <strong>What NEVER Changes:</strong><br>
                        ‚Ä¢ <code>buy_price</code> - Locked at entry<br>
                        ‚Ä¢ <code>buy_time</code> - Locked at entry<br>
                        ‚Ä¢ <code>qty</code> - Locked at entry<br>
                        ‚Ä¢ <code>stop_loss</code> - Locked at entry (rounded to 10 paise)<br>
                        ‚Ä¢ <code>sell_price</code> - LOCKED once trade exits (exit_reason set)<br>
                        ‚Ä¢ <code>sell_time</code> - LOCKED once trade exits
                    </div>

                    <div class="info-box">
                        <strong>What Gets SKIPPED:</strong><br>
                        ‚Ä¢ All <code>status='no_entry'</code> trades<br>
                        ‚Ä¢ Never processed in hourly updates<br>
                        ‚Ä¢ Remain "No Entry" permanently<br>
                        ‚Ä¢ No sell price updates for these trades
                    </div>

                    <p><strong>Schedule:</strong></p>
                    <ul>
                        <li>9:15 AM - First update</li>
                        <li>10:15 AM - Second update</li>
                        <li>11:15 AM - Third update</li>
                        <li>12:15 PM - Fourth update</li>
                        <li>1:15 PM - Fifth update</li>
                        <li>2:15 PM - Sixth update</li>
                        <li><strong>3:15 PM - Seventh update</strong></li>
                        <li><strong>3:25 PM+ - TIME-BASED EXIT (all trades closed)</strong></li>
                    </ul>
                </div>

                <!-- User-Friendly Summary -->
                <div id="user-summary" class="user-content">
                    <h2>üì± User-Friendly Summary</h2>

                    <h3>What You Need to Know</h3>

                    <div class="info-box">
                        <strong>üìä You ALWAYS See Both Sections (NEW!):</strong><br>
                        ‚Ä¢ BULLISH alerts - ALL received CALL signals<br>
                        ‚Ä¢ BEARISH alerts - ALL received PUT signals<br>
                        ‚Ä¢ <strong>Both sections shown regardless of index trends</strong><br>
                        ‚Ä¢ Complete market awareness
                    </div>

                    <div class="success-box">
                        <strong>‚úÖ When Trades Are ENTERED (Both Green ‚Üë or Both Red ‚Üì):</strong><br>
                        ‚Ä¢ Both indices same direction = Trades entered automatically<br>
                        ‚Ä¢ Buy Price, Qty, Stop Loss all set<br>
                        ‚Ä¢ Trade tracking begins<br>
                        ‚Ä¢ Full risk management active
                    </div>

                    <div class="danger-box">
                        <strong>‚ö†Ô∏è When Trades Show "No Entry" (Opposite Trends):</strong><br>
                        ‚Ä¢ One Green ‚Üë, One Red ‚Üì = Trade NOT entered<br>
                        ‚Ä¢ Alert still displayed for awareness<br>
                        ‚Ä¢ Buy Price shows "No Entry" in red<br>
                        ‚Ä¢ Qty = 0, SL/Sell/PnL show "-"<br>
                        ‚Ä¢ <strong>Will NEVER be entered later</strong>
                    </div>

                    <div class="warning-box">
                        <strong>‚è∞ ALL Trades Close by 3:25 PM (NEW!):</strong><br>
                        ‚Ä¢ Automatic time-based exit every day<br>
                        ‚Ä¢ No overnight positions<br>
                        ‚Ä¢ Shows ‚è∞ TIME badge when closed<br>
                        ‚Ä¢ Professional intraday discipline
                    </div>

                    <div class="success-box">
                        <strong>üü¢ When to Hold:</strong><br>
                        ‚Ä¢ Stock price ABOVE average (VWAP)<br>
                        ‚Ä¢ Positive momentum<br>
                        ‚Ä¢ Keep your position
                    </div>

                    <div class="danger-box">
                        <strong>üî¥ When to Exit:</strong><br>
                        ‚Ä¢ Stock price BELOW average (VWAP)<br>
                        ‚Ä¢ Losing momentum<br>
                        ‚Ä¢ Book profits and exit
                    </div>

                    <h3>Quick Actions</h3>
                    <p><strong>Download Your Alerts:</strong></p>
                    <ul>
                        <li>Click "üì• Download CSV" button</li>
                        <li>Get Excel file with all recommendations</li>
                        <li>Keep records for your trading journal</li>
                    </ul>

                    <p><strong>Refresh Data Manually:</strong></p>
                    <ul>
                        <li>Page auto-refreshes every hour</li>
                        <li>Or close and reopen browser tab</li>
                        <li>All latest data loads automatically</li>
                    </ul>

                    <p><strong>Update Upstox Connection:</strong></p>
                    <ul>
                        <li>If you see "Token Expired" warning</li>
                        <li>Click "Login with Upstox" button</li>
                        <li>Authorize and come back</li>
                        <li>Page will refresh automatically</li>
                    </ul>
                </div>
            </div>

            <!-- FOR DEVELOPERS SECTION -->
            <div id="for-developers">
                <h1 class="section-header">üë®‚Äçüíª FOR DEVELOPERS</h1>

                <div id="page-initialization" class="dev-content">
                    <h2>Page Initialization Flow</h2>
                    <p>When the scan page loads, the following sequence occurs:</p>
                    
                    <ol>
                        <li><strong>DOM Ready:</strong> Wait for <code>DOMContentLoaded</code> event</li>
                        <li><strong>Check OAuth Status:</strong> Look for <code>?auth=success</code> or <code>?auth=error</code> URL parameters</li>
                        <li><strong>Load Index Prices:</strong> Fetch NIFTY 50 and BANKNIFTY current prices and trends</li>
                        <li><strong>Load Latest Data:</strong> Fetch existing webhook alerts from backend</li>
                        <li><strong>Start Auto-Refresh:</strong> Begin hourly polling at :15 minute mark</li>
                    </ol>

                    <pre><code>// Main initialization
document.addEventListener('DOMContentLoaded', function() {
    checkOAuthSuccess();
    loadIndexPrices();
    loadLatestData();
    startAutoRefresh();
});</code></pre>
                </div>

                <div id="index-monitoring" class="dev-content">
                    <h2>Index Price Monitoring</h2>
                    
                    <h3>API Endpoint</h3>
                    <p><code>GET /scan/index-prices</code></p>

                    <h3>Index Trend Determination Logic</h3>
                    <div class="info-box">
                        <strong>Algorithm:</strong><br>
                        ‚Ä¢ Fetch current LTP (Last Traded Price)<br>
                        ‚Ä¢ Fetch today's opening price<br>
                        ‚Ä¢ Compare: <code>trend = "bullish" if LTP > open_price else "bearish"</code><br>
                        ‚Ä¢ NOT based on VWAP - uses candle color logic
                    </div>

                    <pre><code>def check_index_trends(self) -> dict:
    nifty_data = self.get_quote("NSE_INDEX|Nifty 50")
    banknifty_data = self.get_quote("NSE_INDEX|Nifty Bank")
    
    nifty_trend = "bullish" if nifty_ltp > nifty_open else "bearish"
    banknifty_trend = "bullish" if bank_ltp > bank_open else "bearish"
    
    return {
        "nifty": {"ltp": nifty_ltp, "trend": nifty_trend},
        "banknifty": {"ltp": bank_ltp, "trend": banknifty_trend}
    }</code></pre>
                </div>

                <div id="webhook-processing" class="dev-content">
                    <h2>Webhook Processing</h2>
                    
                    <h3>Chartink Integration</h3>
                    <p><code>POST /scan/webhook</code></p>

                    <h3>Processing Flow</h3>
                    <ol>
                        <li>Receive stock alert from Chartink</li>
                        <li>Determine option expiry date (based on 18th cutoff)</li>
                        <li>Fetch stock LTP and VWAP from Upstox</li>
                        <li>Get option chain for stock</li>
                        <li>Find optimal strike (OTM-1 to OTM-5 with highest liquidity)</li>
                        <li>Fetch lot size from master_stock table</li>
                        <li><strong>Check index trends (NIFTY & BANKNIFTY) - NEW!</strong></li>
                        <li><strong>Make trade entry decision based on trends - NEW!</strong></li>
                        <li>If trends aligned: Calculate Stop Loss, set buy_price, qty, status='bought'</li>
                        <li>If opposite trends: Set qty=0, buy_price=NULL, status='no_entry'</li>
                        <li>Store in database as IntradayStockOption</li>
                        <li><strong>Alert ALWAYS displayed regardless of entry decision</strong></li>
                    </ol>

                    <h3>Trade Entry Decision Logic (NEW!)</h3>
                    <div class="warning-box">
                        <strong>CRITICAL:</strong> Index trends determine trade ENTRY, not alert VISIBILITY!
                    </div>

                    <pre><code># Check index trends at webhook receipt
index_trends = vwap_service.check_index_trends()
nifty_trend = index_trends.get("nifty", {}).get("trend")
banknifty_trend = index_trends.get("banknifty", {}).get("trend")

# Determine if trade entry is allowed
can_enter_trade = False
if (nifty_trend == "bullish" and banknifty_trend == "bullish") or \
   (nifty_trend == "bearish" and banknifty_trend == "bearish"):
    can_enter_trade = True

if can_enter_trade:
    # ENTER TRADE
    qty = lot_size
    buy_price = option_ltp
    buy_time = current_time
    stop_loss = calculate_sl(option_ltp, qty)
    status = 'bought'
else:
    # NO ENTRY
    qty = 0
    buy_price = NULL
    buy_time = NULL
    stop_loss = NULL
    status = 'no_entry'

# Store alert in database (ALWAYS stored, regardless of entry)
# Alert will be displayed on frontend with entry status</code></pre>

                    <h3>Expiry Date Logic</h3>
                    <div class="info-box">
                        <strong>Rule:</strong><br>
                        ‚Ä¢ If current date ‚â§ 18th ‚Üí Use current month expiry<br>
                        ‚Ä¢ If current date > 18th ‚Üí Use next month expiry<br>
                        ‚Ä¢ Expiry = Last Tuesday of the month
                    </div>

                    <pre><code>def get_monthly_expiry(self, reference_date: datetime = None):
    if reference_date.day <= 18:
        expiry_month = reference_date.month
        expiry_year = reference_date.year
    else:
        # Use next month
        if reference_date.month == 12:
            expiry_month = 1
            expiry_year = reference_date.year + 1
        else:
            expiry_month = reference_date.month + 1
            expiry_year = reference_date.year
    
    # Find last Tuesday of the month
    # ... (calculation logic)</code></pre>
                </div>

                <div id="trading-logic" class="dev-content">
                    <h2>Trading Logic & Algorithms</h2>

                    <h3>Strike Selection (OTM-1 to OTM-5)</h3>
                    <div class="warning-box">
                        <strong>NEW ALGORITHM:</strong> Instead of just OTM-1, we now consider OTM-1 through OTM-5 and select the strike with highest <code>volume √ó OI</code> for better liquidity.
                    </div>

                    <pre><code>def find_strike_from_option_chain(vwap_service, stock_name, option_type, stock_ltp):
    option_chain = vwap_service.get_option_chain(stock_name, expiry_date)
    
    # Filter out-of-money strikes
    if option_type == "CE":
        otm_strikes = [s for s in strikes if s['strike_price'] > stock_ltp]
    else:  # PE
        otm_strikes = [s for s in strikes if s['strike_price'] < stock_ltp]
    
    # Sort by distance from LTP
    otm_strikes.sort(key=lambda x: abs(x['strike_price'] - stock_ltp))
    
    # Get OTM-1 to OTM-5
    otm_1_to_5 = otm_strikes[:5]
    
    # Select strike with highest liquidity (volume √ó OI)
    selected = max(otm_1_to_5, key=lambda x: x['volume'] * x['oi'])
    
    return selected</code></pre>

                    <h3>Quantity Calculation</h3>
                    <div class="success-box">
                        <strong>CORRECT LOGIC:</strong> Quantity is <strong>NOT</strong> calculated from a fixed margin. It uses the official <code>lot_size</code> from Upstox instruments data, stored in the <code>master_stock</code> table.
                    </div>

                    <pre><code># Fetch lot size from database
master_stock = db.query(MasterStock).filter(
    MasterStock.stock_name == stock_name
).first()

if master_stock:
    qty = master_stock.lot_size  # Official exchange lot size
else:
    qty = 1  # Fallback</code></pre>

                    <h3>Stop Loss Calculation - UPDATED!</h3>
                    <div class="danger-box">
                        <strong>RISK MANAGEMENT (UPDATED!):</strong> Stop Loss is calculated automatically when a trade is created to limit maximum loss to approximately <strong>‚Çπ3,100 per trade</strong>. The SL is now <strong>rounded DOWN to the nearest 10 paise</strong> for cleaner pricing.
                    </div>

                    <pre><code>SL_LOSS_TARGET = 3100.0  # Target loss for stop loss trigger

# Calculate Stop Loss (SL) price - UPDATED with rounding!
# SL should trigger when loss reaches approximately -‚Çπ3,100
# Formula: SL_price = floor((buy_price - (SL_LOSS_TARGET / qty)) / 0.10) * 0.10
import math

stop_loss_price = None
if option_ltp_value > 0 and qty > 0:
    # Calculate raw SL
    calculated_sl = option_ltp_value - (SL_LOSS_TARGET / qty)
    # Round DOWN to nearest 10 paise (0.10)
    stop_loss_price = max(0.05, math.floor(calculated_sl / 0.10) * 0.10)
    # Ensure SL is at least ‚Çπ0.05 (minimum tick size)</code></pre>

                    <p><strong>Example:</strong></p>
                    <ul>
                        <li>Buy Price (option_ltp): ‚Çπ25.50</li>
                        <li>Quantity: 250 contracts</li>
                        <li>SL Loss Target: ‚Çπ3,100</li>
                        <li><strong>Stop Loss = ‚Çπ25.50 - (‚Çπ3,100 / 250) = ‚Çπ25.50 - ‚Çπ12.40 = ‚Çπ13.10</strong></li>
                        <li>If option price drops to ‚Çπ13.10 ‚Üí Auto-exit with ~‚Çπ3,100 loss</li>
                    </ul>

                    <h3>Auto-Exit Logic (Hourly Monitoring) - UPDATED!</h3>
                    <div class="warning-box">
                        <strong>CRITICAL:</strong> Once a trade is closed (exit_reason is set), <code>sell_price</code> and <code>sell_time</code> are <strong>PERMANENTLY LOCKED</strong> and cannot be overwritten by any process.
                    </div>

                    <div class="danger-box">
                        <strong>NO RE-ENTRY:</strong> Trades with <code>status='no_entry'</code> are <strong>SKIPPED</strong> in hourly refresh and will <strong>NEVER</strong> be entered later.
                    </div>
                    
                    <div class="success-box">
                        <strong>üÜï RECENT IMPROVEMENTS:</strong><br>
                        ‚Ä¢ <strong>Sell Price Updates:</strong> Now fetches option LTP hourly from instruments data<br>
                        ‚Ä¢ <strong>Bug Fixed:</strong> Instruments JSON correctly parsed as list (was trying .items() on list)<br>
                        ‚Ä¢ <strong>Sell Time Fix:</strong> No longer updates sell_time for open trades (only on exit)<br>
                        ‚Ä¢ <strong>SL Rounding:</strong> Stop Loss rounded to nearest 10 paise for cleaner pricing<br>
                        ‚Ä¢ <strong>OHLC API Fix:</strong> Changed interval from "day" to "1d" for Upstox compatibility
                    </div>

                    <pre><code># Get all records for today (SKIP 'no_entry' trades)
records = db.query(IntradayStockOption).filter(
    IntradayStockOption.trade_date == today,
    IntradayStockOption.status != 'no_entry'  # Skip no_entry trades
).all()

# Check if it's time-based exit time (3:25 PM IST)
current_time = now.time()
exit_time = datetime.strptime("15:25", "%H:%M").time()
is_exit_time = current_time >= exit_time

for record in records:
    # Fetch new option_ltp from Upstox
    new_option_ltp = fetch_option_ltp(record.option_contract)
    
    # Update stock_ltp and stock_vwap (fresh values)
    record.stock_ltp = fetch_stock_ltp(record.stock_name)
    record.stock_vwap = fetch_stock_vwap(record.stock_name)
    record.option_ltp = new_option_ltp
    
    # Only update sell_price if trade is not already closed
    if not record.exit_reason:
        # THREE EXIT CONDITIONS (checked in priority order):
        
        # 1. TIME-BASED EXIT (3:25 PM) - Highest priority
        if is_exit_time:
            record.sell_price = new_option_ltp
            record.sell_time = now
            record.exit_reason = 'time_based'
            record.status = 'sold'
            record.pnl = (new_option_ltp - record.buy_price) * record.qty
            print(f"‚è∞ TIME EXIT (3:25 PM): {record.stock_name}")
        
        # 2. STOP LOSS HIT
        elif record.stop_loss and new_option_ltp <= record.stop_loss:
            record.sell_price = new_option_ltp
            record.sell_time = now
            record.exit_reason = 'stop_loss'
            record.status = 'sold'
            record.pnl = (new_option_ltp - record.buy_price) * record.qty
            print(f"üõë STOP LOSS HIT: {record.stock_name}")
        
        # 3. PROFIT TARGET HIT (50% gain)
        elif record.buy_price and new_option_ltp >= (record.buy_price * 1.5):
            record.sell_price = new_option_ltp
            record.sell_time = now
            record.exit_reason = 'profit_target'
            record.status = 'sold'
            record.pnl = (new_option_ltp - record.buy_price) * record.qty
            print(f"üéØ PROFIT TARGET HIT: {record.stock_name}")
        
        # Otherwise, just update current price and PnL
        else:
            record.sell_price = new_option_ltp
            record.sell_time = now
            record.pnl = (new_option_ltp - record.buy_price) * record.qty
    else:
        # Trade already closed - sell_price is LOCKED
        # Just calculate PnL for display
        record.pnl = (record.sell_price - record.buy_price) * record.qty</code></pre>

                    <h3>Exit Reasons & Status Values</h3>
                    <table>
                        <thead>
                            <tr>
                                <th>Status/exit_reason</th>
                                <th>Trigger Condition</th>
                                <th>Display</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td><code>no_entry</code></td>
                                <td>Opposite index trends at alert time</td>
                                <td><strong>No Entry</strong> (red badge)</td>
                            </tr>
                            <tr>
                                <td><code>time_based</code></td>
                                <td>Time ‚â• 3:25 PM IST</td>
                                <td>‚è∞ TIME (orange badge)</td>
                            </tr>
                            <tr>
                                <td><code>stop_loss</code></td>
                                <td>option_ltp ‚â§ stop_loss</td>
                                <td>üõë SL HIT (red badge)</td>
                            </tr>
                            <tr>
                                <td><code>profit_target</code></td>
                                <td>option_ltp ‚â• buy_price √ó 1.5</td>
                                <td>üéØ TARGET (green badge)</td>
                            </tr>
                            <tr>
                                <td><code>NULL</code> (open trade)</td>
                                <td>Trade still active, monitoring</td>
                                <td>‚úñ EXIT or (hidden)</td>
                            </tr>
                        </tbody>
                    </table>

                    <h3>‚è∞ Mandatory Intraday Closure (NEW!)</h3>
                    <div class="warning-box">
                        <strong>NO OVERNIGHT POSITIONS:</strong><br>
                        ‚Ä¢ At <strong>3:25 PM IST</strong> every trading day<br>
                        ‚Ä¢ ALL open trades are automatically closed<br>
                        ‚Ä¢ <code>exit_reason = 'time_based'</code><br>
                        ‚Ä¢ <code>sell_price = current option_ltp</code><br>
                        ‚Ä¢ Ensures 100% intraday discipline<br>
                        ‚Ä¢ Professional risk management
                    </div>

                    <h3>Hold/Exit Signal Logic (Open Trades Only)</h3>
                    <pre><code># For open trades (no exit_reason)
if stock_ltp >= stock_vwap:
    signal = "Hold"  # Hidden (no display)
else:
    signal = "Exit"  # Big red cross (‚úñ) - pulsing</code></pre>
                </div>

                <div id="authentication" class="dev-content">
                    <h2>Authentication Flows - UPDATED!</h2>

                    <h3>Upstox OAuth 2.0 with Token Persistence</h3>
                    <p><strong>Login Flow (UPDATED!):</strong></p>
                    <ol>
                        <li>User clicks "Login with Upstox" button</li>
                        <li>Frontend redirects to <code>GET /scan/upstox/login</code></li>
                        <li>Backend generates state token and auth URL</li>
                        <li>User is redirected to Upstox authorization page</li>
                        <li>After approval, Upstox redirects to <code>GET /scan/upstox/callback?code=...</code></li>
                        <li>Backend exchanges code for access token</li>
                        <li><strong>üÜï Token is saved to persistent file (token_manager.py)</strong></li>
                        <li><strong>üÜï Token is updated in memory for immediate use</strong></li>
                        <li><strong>üÜï Token is backed up in upstox_service.py</strong></li>
                        <li>User is redirected back to <code>/scan.html?auth=success</code></li>
                    </ol>

                    <div class="success-box">
                        <strong>üÜï Token Persistence Architecture:</strong><br>
                        ‚Ä¢ <strong>File:</strong> backend/services/token_manager.py<br>
                        ‚Ä¢ <strong>Storage:</strong> /home/ubuntu/trademanthan/data/upstox_token.json<br>
                        ‚Ä¢ <strong>Permissions:</strong> 0600 (secure file permissions)<br>
                        ‚Ä¢ <strong>Format:</strong> JSON with access_token and expires_at<br>
                        ‚Ä¢ <strong>Reload:</strong> Automatically loaded on service startup<br>
                        ‚Ä¢ <strong>Health Check:</strong> Validated every 15 minutes
                    </div>

                    <div class="warning-box">
                        <strong>Important:</strong> Access token is updated in THREE places:<br>
                        1. <strong>Persistent File</strong> - Survives restarts<br>
                        2. <strong>Memory (vwap_service)</strong> - Immediate use<br>
                        3. <strong>Backup (upstox_service.py)</strong> - Redundancy<br><br>
                        This ensures no service restart is needed and token persists.
                    </div>

                    <pre><code># Token Manager - Save token persistently
from services.token_manager import save_upstox_token

# Save to file (persists across restarts)
save_upstox_token(access_token, expires_at)

# Update in memory (immediate use)
if hasattr(vwap_service, 'access_token'):
    vwap_service.access_token = access_token
if hasattr(vwap_service, 'upstox'):
    vwap_service.upstox.set_access_token(access_token)
    
# Also update backup in upstox_service.py
upstox_service.reload_token_from_storage()</code></pre>

                    <h3>üÜï Token Health Monitoring</h3>
                    <p><strong>File:</strong> backend/services/health_monitor.py</p>
                    <div class="info-box">
                        <strong>Automatic Health Checks:</strong><br>
                        ‚Ä¢ Runs every 15 minutes (9 AM - 4 PM IST)<br>
                        ‚Ä¢ Reloads token from storage before check<br>
                        ‚Ä¢ Validates token with Upstox API<br>
                        ‚Ä¢ Reports failures in daily health summary<br>
                        ‚Ä¢ Frontend displays banner if token expired
                    </div>

                    <pre><code># Health check with token reload
def perform_health_check():
    # Reload token from persistent storage
    upstox_service.reload_token_from_storage()
    
    # Test API with current token
    status = upstox_service.test_connection()
    
    # Log and report status
    logger.info(f"Upstox API: {status}")</code></pre>
                </div>

                <div id="api-endpoints" class="dev-content">
                    <h2>API Endpoints</h2>

                    <table>
                        <thead>
                            <tr>
                                <th>Endpoint</th>
                                <th>Method</th>
                                <th>Description</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td><code>/scan/index-prices</code></td>
                                <td>GET</td>
                                <td>Get NIFTY & BANKNIFTY current prices and trends</td>
                            </tr>
                            <tr>
                                <td><code>/scan/webhook</code></td>
                                <td>POST</td>
                                <td>Receive stock alerts from Chartink</td>
                            </tr>
                            <tr>
                                <td><code>/scan/latest</code></td>
                                <td>GET</td>
                                <td>Get all today's alerts (bullish & bearish)</td>
                            </tr>
                            <tr>
                                <td><code>/scan/upstox/login</code></td>
                                <td>GET</td>
                                <td>Initiate Upstox OAuth flow</td>
                            </tr>
                            <tr>
                                <td><code>/scan/upstox/callback</code></td>
                                <td>GET</td>
                                <td>Handle Upstox OAuth callback</td>
                            </tr>
                        </tbody>
                    </table>

                    <h3>Response Examples</h3>
                    <pre><code>// GET /scan/index-prices
{
  "nifty": {
    "ltp": 24500.50,
    "trend": "bullish",
    "open": 24450.00
  },
  "banknifty": {
    "ltp": 52300.75,
    "trend": "bullish",
    "open": 52200.00
  }
}</code></pre>

                    <pre><code>// GET /scan/latest
{
  "bullish": [
    {
      "stock_name": "RELIANCE",
      "stock_ltp": 2450.50,
      "stock_vwap": 2448.25,
      "option_name": "RELIANCE 25NOV 2500 CE",
      "qty": 250,
      "buy_price": 25.50,
      "sell_price": 38.25,
      "pnl": 3187.50,
      "signal": "Hold"
    }
  ],
  "bearish": [...]
}</code></pre>
                </div>
            </div>

            <!-- System Workflow Documentation -->
            <div id="system-workflow" class="dev-content" style="margin-top: 60px;">
                <h1 class="section-header">üìä SCAN ALGO SYSTEM WORKFLOW</h1>
                <p>Complete technical workflow with function names and file locations</p>

                <h2>üîÑ Complete System Architecture</h2>
                
                <pre style="background: #f8fafc; color: #1e293b; border: 2px solid #cbd5e1; line-height: 1.8;">
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                          üåê CHARTINK WEBHOOK (External)                             ‚îÇ
‚îÇ                     https://chartink.com ‚Üí TradeManthan Server                      ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                                     ‚îÇ
                                     ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  STEP 1: WEBHOOK RECEPTION                                                          ‚îÇ
‚îÇ  ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ  ‚îÇ
‚îÇ                                                                                     ‚îÇ
‚îÇ  üìç File: backend/routers/scan.py                                                   ‚îÇ
‚îÇ  üìç Endpoints:                                                                      ‚îÇ
‚îÇ     ‚Ä¢ POST /scan/chartink-webhook-bullish                                          ‚îÇ
‚îÇ       ‚îî‚îÄ receive_bullish_webhook(request: Request, db: Session)                    ‚îÇ
‚îÇ                                                                                     ‚îÇ
‚îÇ     ‚Ä¢ POST /scan/chartink-webhook-bearish                                          ‚îÇ
‚îÇ       ‚îî‚îÄ receive_bearish_webhook(request: Request, db: Session)                    ‚îÇ
‚îÇ                                                                                     ‚îÇ
‚îÇ  ‚öôÔ∏è  Both webhooks call:                                                            ‚îÇ
‚îÇ     ‚îî‚îÄ process_webhook_data(data: dict, alert_type: str, db: Session)              ‚îÇ
‚îÇ                                                                                     ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                                     ‚îÇ
                                     ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  STEP 2: INDEX TREND CHECK                                                          ‚îÇ
‚îÇ  ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ  ‚îÇ
‚îÇ                                                                                     ‚îÇ
‚îÇ  üìç File: backend/services/upstox_service.py                                        ‚îÇ
‚îÇ  üìç Function: check_index_trends()                                                  ‚îÇ
‚îÇ                                                                                     ‚îÇ
‚îÇ  ‚öôÔ∏è  Sub-functions called:                                                          ‚îÇ
‚îÇ     ‚îú‚îÄ get_ohlc_data(instrument_key) - Fetch OHLC for NIFTY & BANKNIFTY            ‚îÇ
‚îÇ     ‚îú‚îÄ Determines: bullish/bearish based on LTP vs Day Open                        ‚îÇ
‚îÇ     ‚îî‚îÄ Returns: {nifty_trend, banknifty_trend, opposite_trends, allow_trading}     ‚îÇ
‚îÇ                                                                                     ‚îÇ
‚îÇ  ‚úÖ Decision Logic:                                                                  ‚îÇ
‚îÇ     IF (both bullish) OR (both bearish) ‚Üí allow_trading = True                     ‚îÇ
‚îÇ     ELSE (opposite trends) ‚Üí allow_trading = False                                 ‚îÇ
‚îÇ                                                                                     ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                                     ‚îÇ
                                     ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  STEP 3: DATA ENRICHMENT                                                            ‚îÇ
‚îÇ  ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ  ‚îÇ
‚îÇ                                                                                     ‚îÇ
‚îÇ  üìç File: backend/routers/scan.py                                                   ‚îÇ
‚îÇ  üìç Function: enrich_stock_data(stocks: List[str], alert_type: str, db: Session)   ‚îÇ
‚îÇ                                                                                     ‚îÇ
‚îÇ  ‚öôÔ∏è  For each stock in alert:                                                       ‚îÇ
‚îÇ     ‚îú‚îÄ upstox_service.get_stock_ltp_from_market_quote(stock_name)                  ‚îÇ
‚îÇ     ‚îú‚îÄ upstox_service.get_stock_vwap(stock_name)                                   ‚îÇ
‚îÇ     ‚îú‚îÄ get_monthly_expiry(reference_date) - Determine option expiry                ‚îÇ
‚îÇ     ‚îú‚îÄ upstox_service.get_option_chain(stock_name, expiry_date)                    ‚îÇ
‚îÇ     ‚îú‚îÄ find_strike_from_option_chain() - Select OTM-1 to OTM-5 (highest liquidity) ‚îÇ
‚îÇ     ‚îú‚îÄ get_lot_size_from_master(stock_name, option_contract, db)                   ‚îÇ
‚îÇ     ‚îî‚îÄ upstox_service.get_option_ltp(instrument_key)                               ‚îÇ
‚îÇ                                                                                     ‚îÇ
‚îÇ  üì¶ Returns enriched data with: stock_ltp, stock_vwap, option_contract,            ‚îÇ
‚îÇ     option_ltp, lot_size for each stock                                            ‚îÇ
‚îÇ                                                                                     ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                                     ‚îÇ
                                     ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  STEP 4: TRADE ENTRY DECISION                                                       ‚îÇ
‚îÇ  ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ  ‚îÇ
‚îÇ                                                                                     ‚îÇ
‚îÇ  üìç File: backend/routers/scan.py                                                   ‚îÇ
‚îÇ  üìç Function: process_webhook_data() [continued]                                    ‚îÇ
‚îÇ                                                                                     ‚îÇ
‚îÇ  üîÄ DECISION BRANCH:                                                                 ‚îÇ
‚îÇ                                                                                     ‚îÇ
‚îÇ  ‚úÖ IF allow_trading = True (Trends Aligned):                                       ‚îÇ
‚îÇ     ‚îú‚îÄ status = 'bought'                                                            ‚îÇ
‚îÇ     ‚îú‚îÄ qty = lot_size                                                               ‚îÇ
‚îÇ     ‚îú‚îÄ buy_price = option_ltp                                                       ‚îÇ
‚îÇ     ‚îú‚îÄ buy_time = now                                                               ‚îÇ
‚îÇ     ‚îú‚îÄ stop_loss = max(0.05, floor((buy_price - 3100/qty) / 0.10) * 0.10)          ‚îÇ
‚îÇ     ‚îÇ  ‚îî‚îÄ Rounds down to nearest 10 paise                                           ‚îÇ
‚îÇ     ‚îú‚îÄ sell_price = None (blank, will update hourly)                               ‚îÇ
‚îÇ     ‚îî‚îÄ Trade is ENTERED and tracking begins                                        ‚îÇ
‚îÇ                                                                                     ‚îÇ
‚îÇ  ‚ùå ELSE (Opposite Trends):                                                          ‚îÇ
‚îÇ     ‚îú‚îÄ status = 'no_entry'                                                          ‚îÇ
‚îÇ     ‚îú‚îÄ qty = 0                                                                      ‚îÇ
‚îÇ     ‚îú‚îÄ buy_price = None                                                             ‚îÇ
‚îÇ     ‚îú‚îÄ stop_loss = None                                                             ‚îÇ
‚îÇ     ‚îú‚îÄ sell_price = None                                                            ‚îÇ
‚îÇ     ‚îî‚îÄ Alert stored but NOT entered (permanent NO ENTRY)                           ‚îÇ
‚îÇ                                                                                     ‚îÇ
‚îÇ  üíæ Save to Database: IntradayStockOption model (database.py)                       ‚îÇ
‚îÇ                                                                                     ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                                     ‚îÇ
                                     ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  STEP 5: HOURLY MARKET DATA UPDATES (9:30 AM - 3:15 PM, Every Hour at :15)         ‚îÇ
‚îÇ  ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ  ‚îÇ
‚îÇ                                                                                     ‚îÇ
‚îÇ  üìç File: backend/services/vwap_updater.py                                          ‚îÇ
‚îÇ  üìç Function: update_vwap_for_all_open_positions()                                  ‚îÇ
‚îÇ  üìç Scheduler: VWAPUpdater.start() - APScheduler with CronTrigger                   ‚îÇ
‚îÇ                                                                                     ‚îÇ
‚îÇ  ‚öôÔ∏è  Process:                                                                        ‚îÇ
‚îÇ     1. Query all OPEN positions (status != 'sold', status != 'no_entry')           ‚îÇ
‚îÇ     2. For each position:                                                           ‚îÇ
‚îÇ        ‚îú‚îÄ upstox_service.get_stock_vwap(stock_name) ‚Üí Update stock_vwap            ‚îÇ
‚îÇ        ‚îú‚îÄ upstox_service.get_stock_ltp_from_market_quote() ‚Üí Update stock_ltp      ‚îÇ
‚îÇ        ‚îî‚îÄ Fetch option LTP from instruments JSON ‚Üí Update sell_price               ‚îÇ
‚îÇ                                                                                     ‚îÇ
‚îÇ  üìä Updates 3 key fields hourly:                                                    ‚îÇ
‚îÇ     ‚Ä¢ stock_vwap - For VWAP cross exit logic                                       ‚îÇ
‚îÇ     ‚Ä¢ stock_ltp - For display and monitoring                                       ‚îÇ
‚îÇ     ‚Ä¢ sell_price - Current option price (used for SL/Target checks)                ‚îÇ
‚îÇ                                                                                     ‚îÇ
‚îÇ  ‚ö†Ô∏è  IMPORTANT: status='no_entry' trades are SKIPPED (never processed)              ‚îÇ
‚îÇ                                                                                     ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                                     ‚îÇ
                                     ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  STEP 6: EXIT CONDITION CHECKS (Called after each hourly update)                   ‚îÇ
‚îÇ  ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ  ‚îÇ
‚îÇ                                                                                     ‚îÇ
‚îÇ  üìç File: backend/routers/scan.py                                                   ‚îÇ
‚îÇ  üìç Function: refresh_hourly_prices(db: Session)                                    ‚îÇ
‚îÇ  üìç Endpoint: GET /scan/refresh-hourly-prices                                       ‚îÇ
‚îÇ                                                                                     ‚îÇ
‚îÇ  üîç EXIT CONDITIONS (Checked in Priority Order):                                    ‚îÇ
‚îÇ                                                                                     ‚îÇ
‚îÇ  1Ô∏è‚É£  TIME-BASED EXIT (Highest Priority)                                             ‚îÇ
‚îÇ     ‚îú‚îÄ Condition: current_time >= 15:25 (3:25 PM IST)                              ‚îÇ
‚îÇ     ‚îú‚îÄ exit_reason = 'time_based'                                                  ‚îÇ
‚îÇ     ‚îú‚îÄ status = 'sold'                                                              ‚îÇ
‚îÇ     ‚îú‚îÄ sell_price = current option LTP (LOCKED)                                    ‚îÇ
‚îÇ     ‚îú‚îÄ sell_time = now (LOCKED)                                                    ‚îÇ
‚îÇ     ‚îî‚îÄ Badge: ‚è∞ TIME (Orange)                                                       ‚îÇ
‚îÇ                                                                                     ‚îÇ
‚îÇ  2Ô∏è‚É£  STOP LOSS HIT                                                                   ‚îÇ
‚îÇ     ‚îú‚îÄ Condition: sell_price <= stop_loss                                          ‚îÇ
‚îÇ     ‚îú‚îÄ exit_reason = 'stop_loss'                                                   ‚îÇ
‚îÇ     ‚îú‚îÄ status = 'sold'                                                              ‚îÇ
‚îÇ     ‚îú‚îÄ sell_price = LOCKED at trigger price                                        ‚îÇ
‚îÇ     ‚îú‚îÄ sell_time = LOCKED at trigger time                                          ‚îÇ
‚îÇ     ‚îú‚îÄ Loss capped at ~‚Çπ3,100                                                       ‚îÇ
‚îÇ     ‚îî‚îÄ Badge: üõë SL HIT (Red)                                                        ‚îÇ
‚îÇ                                                                                     ‚îÇ
‚îÇ  3Ô∏è‚É£  PROFIT TARGET HIT                                                               ‚îÇ
‚îÇ     ‚îú‚îÄ Condition: sell_price >= (buy_price * 1.5)                                  ‚îÇ
‚îÇ     ‚îú‚îÄ exit_reason = 'profit_target'                                               ‚îÇ
‚îÇ     ‚îú‚îÄ status = 'sold'                                                              ‚îÇ
‚îÇ     ‚îú‚îÄ sell_price = LOCKED at 50% gain                                             ‚îÇ
‚îÇ     ‚îú‚îÄ sell_time = LOCKED at trigger time                                          ‚îÇ
‚îÇ     ‚îî‚îÄ Badge: üéØ TARGET (Green)                                                      ‚îÇ
‚îÇ                                                                                     ‚îÇ
‚îÇ  4Ô∏è‚É£  VWAP CROSS (Visual Signal Only)                                                 ‚îÇ
‚îÇ     ‚îú‚îÄ Condition: stock_ltp < stock_vwap                                           ‚îÇ
‚îÇ     ‚îú‚îÄ Trade remains OPEN                                                           ‚îÇ
‚îÇ     ‚îú‚îÄ No automatic exit                                                            ‚îÇ
‚îÇ     ‚îî‚îÄ Badge: ‚úñ EXIT (Red Pulsing Cross) - User advisory                            ‚îÇ
‚îÇ                                                                                     ‚îÇ
‚îÇ  ‚ö†Ô∏è  PROTECTION: Once exit_reason is set, sell_price & sell_time are IMMUTABLE!     ‚îÇ
‚îÇ                                                                                     ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                                     ‚îÇ
                                     ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  STEP 7: END-OF-DAY VWAP UPDATE (3:30 PM & 3:35 PM)                                ‚îÇ
‚îÇ  ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ  ‚îÇ
‚îÇ                                                                                     ‚îÇ
‚îÇ  üìç File: backend/services/vwap_updater.py                                          ‚îÇ
‚îÇ  üìç Function: update_end_of_day_vwap()                                              ‚îÇ
‚îÇ  üìç Scheduler: VWAPUpdater.start() - Runs at 15:30 and 15:35 IST                   ‚îÇ
‚îÇ                                                                                     ‚îÇ
‚îÇ  ‚öôÔ∏è  Process:                                                                        ‚îÇ
‚îÇ     1. Query ALL positions from today (both open AND closed)                       ‚îÇ
‚îÇ     2. Get unique stock names                                                       ‚îÇ
‚îÇ     3. For each stock:                                                              ‚îÇ
‚îÇ        ‚îî‚îÄ upstox_service.get_stock_vwap(stock_name) ‚Üí Final day VWAP               ‚îÇ
‚îÇ     4. Update stock_vwap for ALL positions of that stock                           ‚îÇ
‚îÇ                                                                                     ‚îÇ
‚îÇ  üìä Purpose:                                                                         ‚îÇ
‚îÇ     ‚Ä¢ Captures complete trading day VWAP (9:15 AM - 3:30 PM)                       ‚îÇ
‚îÇ     ‚Ä¢ Updates ALL positions (not just open ones)                                   ‚îÇ
‚îÇ     ‚Ä¢ Provides final VWAP for post-trade analysis                                  ‚îÇ
‚îÇ                                                                                     ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                                     ‚îÇ
                                     ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  STEP 8: FRONTEND DISPLAY & USER INTERACTION                                        ‚îÇ
‚îÇ  ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ  ‚îÇ
‚îÇ                                                                                     ‚îÇ
‚îÇ  üìç File: frontend/public/scan.js                                                   ‚îÇ
‚îÇ  üìç File: frontend/public/scan.html                                                 ‚îÇ
‚îÇ  üìç File: frontend/public/scan.css                                                  ‚îÇ
‚îÇ                                                                                     ‚îÇ
‚îÇ  üåê Page Load Sequence:                                                             ‚îÇ
‚îÇ     1. DOMContentLoaded event fires                                                 ‚îÇ
‚îÇ        ‚îî‚îÄ Calls: initializePage()                                                   ‚îÇ
‚îÇ                                                                                     ‚îÇ
‚îÇ     2. Check OAuth Status                                                           ‚îÇ
‚îÇ        ‚îî‚îÄ checkOAuthSuccess() - Displays token refresh confirmation                ‚îÇ
‚îÇ                                                                                     ‚îÇ
‚îÇ     3. Load Index Prices                                                            ‚îÇ
‚îÇ        ‚îî‚îÄ loadIndexPrices()                                                         ‚îÇ
‚îÇ           ‚îî‚îÄ Fetches: GET /scan/index-prices                                        ‚îÇ
‚îÇ           ‚îî‚îÄ Updates title bar: NIFTY ‚Üë/‚Üì, BANKNIFTY ‚Üë/‚Üì                            ‚îÇ
‚îÇ                                                                                     ‚îÇ
‚îÇ     4. Load Latest Data                                                             ‚îÇ
‚îÇ        ‚îî‚îÄ loadLatestData()                                                          ‚îÇ
‚îÇ           ‚îî‚îÄ Fetches: GET /scan/latest                                              ‚îÇ
‚îÇ           ‚îî‚îÄ Calls: displaySectionsBasedOnTrends(data)                              ‚îÇ
‚îÇ                                                                                     ‚îÇ
‚îÇ     5. Display Trade Alerts                                                         ‚îÇ
‚îÇ        ‚îú‚îÄ displayBullishAlerts(bullishData) - Shows ALL bullish alerts             ‚îÇ
‚îÇ        ‚îÇ  ‚îî‚îÄ createStockCard(alert, 'bullish') - Creates visual card               ‚îÇ
‚îÇ        ‚îî‚îÄ displayBearishAlerts(bearishData) - Shows ALL bearish alerts             ‚îÇ
‚îÇ           ‚îî‚îÄ createStockCard(alert, 'bearish') - Creates visual card               ‚îÇ
‚îÇ                                                                                     ‚îÇ
‚îÇ     6. Start Auto-Refresh                                                           ‚îÇ
‚îÇ        ‚îî‚îÄ startAutoRefresh()                                                        ‚îÇ
‚îÇ           ‚îî‚îÄ Sets up hourly refresh at :15 past each hour                           ‚îÇ
‚îÇ                                                                                     ‚îÇ
‚îÇ     7. Token Health Check                                                           ‚îÇ
‚îÇ        ‚îî‚îÄ checkTokenHealth()                                                        ‚îÇ
‚îÇ           ‚îî‚îÄ Fetches: GET /scan/upstox/status                                       ‚îÇ
‚îÇ           ‚îî‚îÄ Shows banner if token expired                                          ‚îÇ
‚îÇ                                                                                     ‚îÇ
‚îÇ     8. Day Summary Calculation                                                      ‚îÇ
‚îÇ        ‚îî‚îÄ updateDaySummary(bullishData, bearishData)                               ‚îÇ
‚îÇ           ‚îî‚îÄ Calculates: Net P&L, Win Rate, Total Trades, SL Exits, etc.           ‚îÇ
‚îÇ                                                                                     ‚îÇ
‚îÇ  üé® Visual Components:                                                               ‚îÇ
‚îÇ     ‚Ä¢ Status Badges: ‚è∞ TIME, üõë SL HIT, üéØ TARGET, ‚úñ EXIT, No Entry               ‚îÇ
‚îÇ     ‚Ä¢ Color Coding: Green (profit), Red (loss/exit), Orange (time/pending)         ‚îÇ
‚îÇ     ‚Ä¢ Real-time P&L: (sell_price - buy_price) √ó qty                                ‚îÇ
‚îÇ     ‚Ä¢ Collapsible Day Summary with key metrics                                     ‚îÇ
‚îÇ                                                                                     ‚îÇ
‚îÇ  üì• User Actions:                                                                    ‚îÇ
‚îÇ     ‚Ä¢ Download CSV: exportToCSV() - Exports all alerts to Excel                    ‚îÇ
‚îÇ     ‚Ä¢ Upstox Login: Redirects to /scan/upstox/login                                ‚îÇ
‚îÇ     ‚Ä¢ Toggle Summary: toggleDaySummary() - Expand/collapse day stats               ‚îÇ
‚îÇ                                                                                     ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
</pre>

                <h2>üìÇ File Structure Reference</h2>
                <table>
                    <thead>
                        <tr>
                            <th>Component</th>
                            <th>File Path</th>
                            <th>Key Functions/Classes</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td><strong>Webhook Handler</strong></td>
                            <td><code>backend/routers/scan.py</code></td>
                            <td>
                                ‚Ä¢ receive_bullish_webhook()<br>
                                ‚Ä¢ receive_bearish_webhook()<br>
                                ‚Ä¢ process_webhook_data()<br>
                                ‚Ä¢ enrich_stock_data()<br>
                                ‚Ä¢ refresh_hourly_prices()
                            </td>
                        </tr>
                        <tr>
                            <td><strong>Upstox Integration</strong></td>
                            <td><code>backend/services/upstox_service.py</code></td>
                            <td>
                                ‚Ä¢ UpstoxService class<br>
                                ‚Ä¢ check_index_trends()<br>
                                ‚Ä¢ get_stock_ltp_from_market_quote()<br>
                                ‚Ä¢ get_stock_vwap()<br>
                                ‚Ä¢ get_option_chain()<br>
                                ‚Ä¢ get_option_ltp()<br>
                                ‚Ä¢ get_ohlc_data()
                            </td>
                        </tr>
                        <tr>
                            <td><strong>VWAP Updater</strong></td>
                            <td><code>backend/services/vwap_updater.py</code></td>
                            <td>
                                ‚Ä¢ VWAPUpdater class<br>
                                ‚Ä¢ update_vwap_for_all_open_positions()<br>
                                ‚Ä¢ update_end_of_day_vwap()<br>
                                ‚Ä¢ start_vwap_updater()<br>
                                ‚Ä¢ stop_vwap_updater()
                            </td>
                        </tr>
                        <tr>
                            <td><strong>Token Management</strong></td>
                            <td><code>backend/services/token_manager.py</code></td>
                            <td>
                                ‚Ä¢ save_upstox_token()<br>
                                ‚Ä¢ load_upstox_token()<br>
                                ‚Ä¢ delete_upstox_token()
                            </td>
                        </tr>
                        <tr>
                            <td><strong>Database Models</strong></td>
                            <td><code>backend/models/trading.py</code></td>
                            <td>
                                ‚Ä¢ IntradayStockOption class<br>
                                ‚Ä¢ MasterStock class<br>
                                ‚Ä¢ Broker class
                            </td>
                        </tr>
                        <tr>
                            <td><strong>Database Connection</strong></td>
                            <td><code>backend/database.py</code></td>
                            <td>
                                ‚Ä¢ SessionLocal (SQLAlchemy)<br>
                                ‚Ä¢ engine<br>
                                ‚Ä¢ get_db()
                            </td>
                        </tr>
                        <tr>
                            <td><strong>Frontend Logic</strong></td>
                            <td><code>frontend/public/scan.js</code></td>
                            <td>
                                ‚Ä¢ loadIndexPrices()<br>
                                ‚Ä¢ loadLatestData()<br>
                                ‚Ä¢ displaySectionsBasedOnTrends()<br>
                                ‚Ä¢ createStockCard()<br>
                                ‚Ä¢ updateDaySummary()<br>
                                ‚Ä¢ checkTokenHealth()<br>
                                ‚Ä¢ startAutoRefresh()<br>
                                ‚Ä¢ exportToCSV()
                            </td>
                        </tr>
                        <tr>
                            <td><strong>Frontend Styling</strong></td>
                            <td><code>frontend/public/scan.css</code></td>
                            <td>
                                ‚Ä¢ Status badge styles<br>
                                ‚Ä¢ Table layouts<br>
                                ‚Ä¢ Responsive design<br>
                                ‚Ä¢ Day summary container
                            </td>
                        </tr>
                        <tr>
                            <td><strong>Frontend HTML</strong></td>
                            <td><code>frontend/public/scan.html</code></td>
                            <td>
                                ‚Ä¢ Page structure<br>
                                ‚Ä¢ Day summary section<br>
                                ‚Ä¢ Alert tables<br>
                                ‚Ä¢ Token expired banner
                            </td>
                        </tr>
                        <tr>
                            <td><strong>Main Application</strong></td>
                            <td><code>backend/main.py</code></td>
                            <td>
                                ‚Ä¢ FastAPI app initialization<br>
                                ‚Ä¢ startup_event()<br>
                                ‚Ä¢ shutdown_event()<br>
                                ‚Ä¢ Router includes<br>
                                ‚Ä¢ Service startup/shutdown
                            </td>
                        </tr>
                    </tbody>
                </table>

                <h2>üîë Key Constants & Configurations</h2>
                <table>
                    <thead>
                        <tr>
                            <th>Constant</th>
                            <th>Value</th>
                            <th>Location</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td><code>SL_LOSS_TARGET</code></td>
                            <td>‚Çπ3,100</td>
                            <td>backend/routers/scan.py</td>
                        </tr>
                        <tr>
                            <td><code>PROFIT_TARGET_MULTIPLIER</code></td>
                            <td>1.5 (50% gain)</td>
                            <td>backend/routers/scan.py</td>
                        </tr>
                        <tr>
                            <td><code>TIME_BASED_EXIT</code></td>
                            <td>15:25 (3:25 PM IST)</td>
                            <td>backend/routers/scan.py</td>
                        </tr>
                        <tr>
                            <td><code>HOURLY_UPDATE_TIMES</code></td>
                            <td>9:30, 10:15, 11:15, 12:15, 1:15, 2:15, 3:15</td>
                            <td>backend/services/vwap_updater.py</td>
                        </tr>
                        <tr>
                            <td><code>EOD_VWAP_TIMES</code></td>
                            <td>15:30, 15:35 (3:30 & 3:35 PM IST)</td>
                            <td>backend/services/vwap_updater.py</td>
                        </tr>
                        <tr>
                            <td><code>EXPIRY_CUTOFF_DATE</code></td>
                            <td>18th of month</td>
                            <td>backend/routers/scan.py</td>
                        </tr>
                        <tr>
                            <td><code>OTM_RANGE</code></td>
                            <td>OTM-1 to OTM-5</td>
                            <td>backend/routers/scan.py</td>
                        </tr>
                        <tr>
                            <td><code>STOP_LOSS_ROUNDING</code></td>
                            <td>0.10 (10 paise, rounded down)</td>
                            <td>backend/routers/scan.py</td>
                        </tr>
                    </tbody>
                </table>

                <h2>üîÑ Scheduler Jobs (APScheduler)</h2>
                <table>
                    <thead>
                        <tr>
                            <th>Job Name</th>
                            <th>Schedule</th>
                            <th>Function</th>
                            <th>Purpose</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td><strong>Master Stock Download</strong></td>
                            <td>Daily 9:00 AM IST</td>
                            <td>download_master_stock_data()</td>
                            <td>Download Dhan instruments data</td>
                        </tr>
                        <tr>
                            <td><strong>Instruments Data Refresh</strong></td>
                            <td>Daily 9:05 AM IST</td>
                            <td>fetch_and_store_instruments()</td>
                            <td>Update Upstox instruments JSON</td>
                        </tr>
                        <tr>
                            <td><strong>Hourly Market Updates</strong></td>
                            <td>Hourly at :15 (9:15-3:15)</td>
                            <td>update_vwap_for_all_open_positions()</td>
                            <td>Update VWAP, LTP, sell_price</td>
                        </tr>
                        <tr>
                            <td><strong>EOD VWAP Update</strong></td>
                            <td>3:30 PM & 3:35 PM IST</td>
                            <td>update_end_of_day_vwap()</td>
                            <td>Final day VWAP for all positions</td>
                        </tr>
                        <tr>
                            <td><strong>Health Monitor</strong></td>
                            <td>Every 15 min (9 AM-4 PM)</td>
                            <td>perform_health_check()</td>
                            <td>Monitor Upstox API, database, services</td>
                        </tr>
                    </tbody>
                </table>

                <div class="success-box">
                    <strong>üìå Quick Reference:</strong><br>
                    ‚Ä¢ <strong>Entry Logic:</strong> backend/routers/scan.py ‚Üí process_webhook_data()<br>
                    ‚Ä¢ <strong>Exit Logic:</strong> backend/routers/scan.py ‚Üí refresh_hourly_prices()<br>
                    ‚Ä¢ <strong>Hourly Updates:</strong> backend/services/vwap_updater.py ‚Üí update_vwap_for_all_open_positions()<br>
                    ‚Ä¢ <strong>Frontend Display:</strong> frontend/public/scan.js ‚Üí displaySectionsBasedOnTrends()<br>
                    ‚Ä¢ <strong>Index Trends:</strong> backend/services/upstox_service.py ‚Üí check_index_trends()
                </div>

                <div class="info-box">
                    <strong>üîó Data Flow Summary:</strong><br>
                    Chartink Webhook ‚Üí process_webhook_data() ‚Üí check_index_trends() ‚Üí enrich_stock_data() ‚Üí 
                    Save to DB ‚Üí Hourly: update_vwap_for_all_open_positions() ‚Üí refresh_hourly_prices() ‚Üí 
                    Check Exit Conditions ‚Üí Update DB ‚Üí Frontend: loadLatestData() ‚Üí Display to User
                </div>
            </div>

            <!-- Footer -->
            <div style="margin-top: 60px; padding-top: 30px; border-top: 2px solid #e5e7eb; text-align: center; color: #888;">
                <p><strong>TradeManthan</strong> - Intelligent Trading Solutions</p>
                <p>For support: Contact your administrator</p>
            </div>

        </main>
    </div>

    <!-- Scroll to Top Button -->
    <div class="scroll-top" id="scrollTop">
        <i class="fas fa-arrow-up"></i>
    </div>

    <script>
        // Dropdown menu toggle function
        function toggleMenu() {
            const dropdown = document.getElementById('menu-dropdown');
            dropdown.classList.toggle('show');
        }

        // Close dropdown when clicking outside
        window.addEventListener('click', function(event) {
            const dropdown = document.getElementById('menu-dropdown');
            const menuBtn = event.target.closest('.menu-btn');
            
            if (!menuBtn && dropdown && dropdown.classList.contains('show')) {
                dropdown.classList.remove('show');
            }
        });

        // Smooth scrolling for TOC links
        document.querySelectorAll('a[href^="#"]').forEach(anchor => {
            anchor.addEventListener('click', function (e) {
                e.preventDefault();
                const target = document.querySelector(this.getAttribute('href'));
                if (target) {
                    target.scrollIntoView({
                        behavior: 'smooth',
                        block: 'start'
                    });
                }
            });
        });

        // Scroll to top button
        const scrollTopBtn = document.getElementById('scrollTop');
        
        window.addEventListener('scroll', function() {
            if (window.pageYOffset > 300) {
                scrollTopBtn.classList.add('visible');
            } else {
                scrollTopBtn.classList.remove('visible');
            }
        });

        scrollTopBtn.addEventListener('click', function() {
            window.scrollTo({
                top: 0,
                behavior: 'smooth'
            });
        });

        // Highlight active TOC item on scroll
        const sections = document.querySelectorAll('[id]');
        const tocLinks = document.querySelectorAll('.toc a');

        window.addEventListener('scroll', function() {
            let current = '';
            sections.forEach(section => {
                const sectionTop = section.offsetTop;
                if (pageYOffset >= sectionTop - 100) {
                    current = section.getAttribute('id');
                }
            });

            tocLinks.forEach(link => {
                link.style.fontWeight = 'normal';
                link.style.background = 'transparent';
                if (link.getAttribute('href') === '#' + current) {
                    link.style.fontWeight = '600';
                    link.style.background = '#f0f4ff';
                }
            });
        });

        // Mobile drawer functions
        function openMobileDrawer() {
            document.getElementById('mobile-drawer').classList.add('show');
            document.getElementById('drawer-overlay').classList.add('show');
            document.body.style.overflow = 'hidden';
        }

        function closeMobileDrawer() {
            document.getElementById('mobile-drawer').classList.remove('show');
            document.getElementById('drawer-overlay').classList.remove('show');
            document.body.style.overflow = '';
        }

        // Close drawer on ESC key
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                closeMobileDrawer();
            }
        });
    </script>

    <!-- Mobile Bottom Bar -->
    <div class="mobile-bottom-bar">
        <button class="mobile-menu-btn" onclick="openMobileDrawer()">
            <i class="fas fa-home"></i>
        </button>
    </div>

    <!-- Mobile Drawer Overlay -->
    <div class="drawer-overlay" id="drawer-overlay" onclick="closeMobileDrawer()"></div>

    <!-- Mobile Drawer Menu -->
    <div class="mobile-drawer" id="mobile-drawer">
        <div class="drawer-handle" onclick="closeMobileDrawer()">
            <div class="drawer-handle-bar"></div>
        </div>
        <div class="drawer-header">
            <h3><i class="fas fa-compass"></i> Navigation</h3>
        </div>
        <div class="drawer-menu">
            <a href="scan.html" class="scan-link">
                <i class="fas fa-search"></i>
                <span>Scan Dashboard</span>
            </a>
            <a href="reportscan.html" class="report-link">
                <i class="fas fa-chart-bar"></i>
                <span>Trading Report</span>
            </a>
            <a href="scanlog.html" class="logs-link">
                <i class="fas fa-file-alt"></i>
                <span>Scan Logs</span>
            </a>
            <a href="help.html" class="help-link">
                <i class="fas fa-question-circle"></i>
                <span>Help Guide</span>
            </a>
        </div>
    </div>

</body>
</html>

